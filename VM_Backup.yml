---
- name: Clone BlueIris and JellyFin VMs in vCenter
  hosts: localhost
  gather_facts: no
  collections:
    - community.vmware

  vars:
    datacenter_name: "Datacenter"
    datastore_name: "Backup_1"
    vm_folder: "vm" 
    date_suffix: "{{ lookup('pipe', 'date +%m%d%Y') }}"
    vms_to_clone:
      - { template: "BlueIris",  base_name: "BlueIris_Backup_" }
      - { template: "JellyFin",  base_name: "JellyFin_Backup_" }

  tasks:
    - name: Clone VMs in vCenter
      vmware_guest:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        validate_certs: no
        datacenter: "{{ datacenter_name }}"
        folder: "{{ vm_folder }}"  
        name: "{{ item.base_name }}{{ date_suffix }}"
        template: "{{ item.template }}"
        datastore: "{{ datastore_name }}"
        state: poweredoff
      loop: "{{ vms_to_clone }}"
    
    - name: Removing backups from Inventory
      community.vmware.vmware_guest_vm_deregister:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        validate_certs: no
        name: "{{ item.base_name }}{{ date_suffix }}"
        state: absent
        remove_from_disk: no
      loop: "{{ vms_to_clone }}"
